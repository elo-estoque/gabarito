<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Gabaritos - Elo Brindes</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center font-sans">

    <div id="app" class="w-full max-w-lg bg-white p-8 rounded-xl shadow-2xl">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-900">üñ®Ô∏è Gabarito Maker</h1>
            <p class="text-gray-500">Selecione a garrafa e baixe o fundo exato.</p>
        </div>

        <div class="mb-6">
            <label class="block text-sm font-bold text-gray-700 mb-2">Produto</label>
            <select v-model="produtoSelecionado" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                <option disabled value="">Selecione um produto...</option>
                <option v-for="prod in listaProdutos" :key="prod.id" :value="prod">
                    {{ prod.nome }} ({{ prod.codigo }})
                </option>
            </select>
        </div>

        <div v-if="produtoSelecionado" class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 mb-6 text-indigo-900 text-sm">
            <div class="flex justify-between mb-1">
                <span>Largura:</span>
                <span class="font-bold">{{ produtoSelecionado.largura }} mm</span>
            </div>
            <div class="flex justify-between">
                <span>Altura:</span>
                <span class="font-bold">{{ produtoSelecionado.altura }} mm</span>
            </div>
        </div>

        <div class="mb-8">
            <label class="block text-sm font-bold text-gray-700 mb-2">Modo de Sa√≠da</label>
            <div class="grid grid-cols-2 gap-4">
                <label :class="{'bg-indigo-600 text-white': modoCor === 'rgb', 'bg-gray-100': modoCor !== 'rgb'}" class="cursor-pointer p-3 rounded text-center transition">
                    <input type="radio" value="rgb" v-model="modoCor" class="hidden">
                    üñ•Ô∏è Visual (RGB)
                </label>
                <label :class="{'bg-indigo-600 text-white': modoCor === 'cmyk', 'bg-gray-100': modoCor !== 'cmyk'}" class="cursor-pointer p-3 rounded text-center transition">
                    <input type="radio" value="cmyk" v-model="modoCor" class="hidden">
                    üñ®Ô∏è Print (CMYK)
                </label>
            </div>
        </div>

        <button 
            @click="baixarGabarito" 
            :disabled="!produtoSelecionado || loading"
            :class="{'opacity-50 cursor-not-allowed': !produtoSelecionado || loading}"
            class="w-full bg-indigo-600 text-white font-bold py-4 rounded-lg hover:bg-indigo-700 transition shadow-lg flex justify-center items-center">
            <span v-if="loading" class="animate-spin h-5 w-5 mr-3 border-2 border-white border-t-transparent rounded-full"></span>
            <span v-if="!loading">Baixar PDF Agora</span>
            <span v-else>Gerando...</span>
        </button>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    loading: false,
                    modoCor: 'cmyk',
                    produtoSelecionado: '',
                    // Aqui pegamos os dados que o Python (Flask) injetou na p√°gina via Jinja2
                    listaProdutos: {{ produtos | tojson }} 
                }
            },
            methods: {
                async baixarGabarito() {
                    this.loading = true;
                    try {
                        const response = await fetch('/gerar-gabarito', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                largura: this.produtoSelecionado.largura,
                                altura: this.produtoSelecionado.altura,
                                nome: this.produtoSelecionado.codigo,
                                cor: this.modoCor
                            })
                        });

                        if (!response.ok) throw new Error('Erro ao gerar');

                        // Truque para baixar o arquivo recebido (Blob)
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Gabarito_${this.produtoSelecionado.codigo}_${this.modoCor.toUpperCase()}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();

                    } catch (error) {
                        alert("Erro ao gerar PDF: " + error.message);
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
