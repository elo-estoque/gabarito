<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Provas - Elo Brindes</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .canvas-wrapper {
            transform-origin: top center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        input[type=number]::-webkit-inner-spin-button {
            opacity: 1;
        }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans p-4">

    <div id="app" class="w-full max-w-[1400px] bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col lg:flex-row h-[90vh]">
        
        <div class="w-full lg:w-1/4 p-6 bg-white border-r border-gray-100 flex flex-col h-full overflow-y-auto z-20 shadow-lg relative">
            <h1 class="text-xl font-bold text-indigo-900 mb-1">üñ®Ô∏è Editor Elo</h1>
            <p class="text-gray-500 text-xs mb-6">Ajuste a arte no gabarito.</p>

            <div class="flex bg-gray-100 rounded-lg p-1 mb-4 text-xs">
                <button @click="modo = 'catalogo'; limparEditor()" :class="{'bg-white shadow text-indigo-900': modo==='catalogo', 'text-gray-500': modo!=='catalogo'}" class="flex-1 py-2 rounded-md font-bold transition">Cat√°logo</button>
                <button @click="modo = 'custom'; limparEditor()" :class="{'bg-white shadow text-indigo-900': modo==='custom', 'text-gray-500': modo!=='custom'}" class="flex-1 py-2 rounded-md font-bold transition">Manual</button>
            </div>

            <div v-if="modo === 'catalogo'" class="mb-4">
                <select v-model="produtoSelecionado" @change="atualizarMedidas" class="w-full p-2 border border-gray-300 rounded text-sm outline-none focus:border-indigo-500 mb-2">
                    <option value="">Buscar produto...</option>
                    <option v-for="prod in listaProdutos" :key="prod.id" :value="prod">[[ prod.nome ]] ([[ prod.codigo ]])</option>
                </select>

                <div v-if="produtoSelecionado" class="bg-indigo-50 border border-indigo-100 rounded-lg p-3 flex justify-between items-center animate-fade-in shadow-sm">
                    <div class="text-center w-1/2 border-r border-indigo-200">
                        <span class="block text-[10px] text-indigo-400 uppercase font-bold tracking-wider">Largura</span>
                        <span class="block text-lg font-extrabold text-indigo-900">[[ medidas.largura ]] cm</span>
                    </div>
                    <div class="text-center w-1/2">
                        <span class="block text-[10px] text-indigo-400 uppercase font-bold tracking-wider">Altura</span>
                        <span class="block text-lg font-extrabold text-indigo-900">[[ medidas.altura ]] cm</span>
                    </div>
                </div>
            </div>

            <div v-if="modo === 'custom'" class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 mb-4">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[10px] font-bold text-gray-500">Largura (cm)</label>
                        <input type="number" step="0.1" v-model="medidas.largura" @change="redimensionarCanvas" class="w-full p-2 border rounded bg-white text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500">Altura (cm)</label>
                        <input type="number" step="0.1" v-model="medidas.altura" @change="redimensionarCanvas" class="w-full p-2 border rounded bg-white text-sm">
                    </div>
                </div>
            </div>

            <hr class="border-gray-200 mb-4">

            <div class="flex-grow flex flex-col">
                
                <label class="flex items-center justify-center w-full p-3 border-2 border-dashed border-indigo-200 rounded-lg text-indigo-600 font-bold cursor-pointer hover:bg-indigo-50 transition mb-4">
                    <i class="fa-solid fa-cloud-arrow-up mr-2"></i>
                    <span class="text-xs">Carregar Arte</span>
                    <input type="file" @change="adicionarImagemCanvas" accept="image/*" class="hidden">
                </label>

                <div v-if="arteSelecionada" class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mb-4 shadow-sm transition-all">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-indigo-900 uppercase"><i class="fa-solid fa-sliders mr-1"></i> Editar Arte</span>
                        <button @click="excluirArte" class="text-red-500 hover:text-red-700 text-xs"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-[10px] font-bold text-gray-500">Largura (cm)</label>
                            <input type="number" step="0.1" v-model="medidasArte.largura" @input="atualizarArtePeloInput('w')" class="w-full p-1 border border-indigo-200 rounded text-sm text-center font-bold text-indigo-900 bg-white">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500">Altura (cm)</label>
                            <input type="number" step="0.1" v-model="medidasArte.altura" @input="atualizarArtePeloInput('h')" class="w-full p-1 border border-indigo-200 rounded text-sm text-center font-bold text-indigo-900 bg-white">
                        </div>
                    </div>

                    <div class="flex items-center justify-between mt-3">
                        <label class="flex items-center cursor-pointer select-none">
                            <input type="checkbox" v-model="bloquearProporcao" class="mr-1.5 h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="text-[10px] font-bold text-gray-600 flex items-center">
                                <i :class="bloquearProporcao ? 'fa-solid fa-link mr-1' : 'fa-solid fa-link-slash mr-1 opacity-50'"></i> Travar
                            </span>
                        </label>
                        
                        <div class="flex space-x-1">
                            <button @click="centralizarArte" class="text-[10px] bg-white border border-indigo-200 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-100 transition" title="Centralizar">
                                <i class="fa-solid fa-crosshairs"></i>
                            </button>
                            <button @click="preencherArte" class="text-[10px] bg-indigo-600 border border-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700 transition" title="Preencher Tudo">
                                <i class="fa-solid fa-expand"></i> Preencher
                            </button>
                        </div>
                    </div>
                </div>

                <div v-else class="text-center text-gray-400 text-xs py-4 border border-gray-100 rounded mb-4 border-dashed">
                    Clique na imagem para editar medidas
                </div>

                <div class="mt-auto space-y-2">
                    <div class="flex items-center mb-2 bg-blue-50 p-2 rounded">
                        <input type="checkbox" id="saveDir" v-model="salvarNoDirectus" class="mr-2 h-4 w-4 accent-indigo-600">
                        <label for="saveDir" class="text-xs text-gray-700 font-bold">Salvar c√≥pia no sistema?</label>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <button @click="baixarPDF('rgb')" :disabled="!validar" class="p-3 rounded-lg border border-gray-300 hover:bg-gray-50 flex flex-col items-center justify-center transition">
                            <span class="text-lg">üñ•Ô∏è</span>
                            <span class="text-[10px] font-bold mt-1">Visual (RGB)</span>
                        </button>
                        <button @click="baixarPDF('cmyk')" :disabled="!validar" class="p-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 flex flex-col items-center justify-center transition shadow-lg">
                            <span class="text-lg">üñ®Ô∏è</span>
                            <span class="text-[10px] font-bold mt-1">Print (CMYK)</span>
                        </button>
                    </div>
                </div>
                <p v-if="loading" class="text-center text-xs text-indigo-600 font-bold mt-2 animate-pulse">Gerando PDF...</p>
            </div>
        </div>

        <div class="w-full lg:w-3/4 bg-slate-200 relative flex flex-col items-center overflow-hidden">
            <div class="w-full bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center shadow-sm z-10 h-12 shrink-0">
                <div class="text-xs font-bold text-gray-500 uppercase flex items-center">
                    <i class="fa-solid fa-ruler-combined mr-2"></i>
                    <span v-if="medidas.largura">Gabarito: [[ medidas.largura ]]cm x [[ medidas.altura ]]cm</span>
                    <span v-else>Sem medidas</span>
                </div>
                <div class="text-xs font-mono text-gray-400 bg-gray-100 px-2 py-1 rounded">
                    Zoom: [[ Math.round(zoomScale * 100) ]]%
                </div>
            </div>
            
            <div ref="canvasContainer" class="flex-grow w-full flex items-center justify-center overflow-hidden relative p-8" @click.self="deselecionarArte">
                <div v-if="!medidas.largura" class="text-center text-gray-400">
                    <p class="font-bold">Selecione um produto ao lado</p>
                </div>

                <div class="canvas-wrapper" :style="{ transform: `scale(${zoomScale})` }">
                    <canvas id="canvasEditor"></canvas>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            compilerOptions: { delimiters: ['[[', ']]'] },
            data() {
                return {
                    modo: 'catalogo',
                    loading: false,
                    listaProdutos: {{ produtos | tojson }},
                    produtoSelecionado: '',
                    canvas: null,
                    medidas: { largura: 0, altura: 0, nome: '' },
                    salvarNoDirectus: true,
                    pixelsPorCm: 60, 
                    zoomScale: 1,
                    
                    arteSelecionada: false, 
                    medidasArte: { largura: 0, altura: 0 },
                    bloquearProporcao: false
                }
            },
            computed: {
                validar() {
                    return this.medidas.largura > 0 && this.medidas.altura > 0;
                }
            },
            mounted() {
                this.canvas = new fabric.Canvas('canvasEditor', {
                    backgroundColor: '#ffffff',
                    preserveObjectStacking: true
                });

                this.canvas.on('selection:created', this.aoSelecionarObjeto);
                this.canvas.on('selection:updated', this.aoSelecionarObjeto);
                this.canvas.on('selection:cleared', this.aoDeselecionarObjeto);
                this.canvas.on('object:modified', this.aoModificarObjeto);
                this.canvas.on('object:scaling', this.aoModificarObjeto);

                window.addEventListener('resize', this.ajustarZoom);
            },
            methods: {
                // --- L√ìGICA DE SELE√á√ÉO E ATUALIZA√á√ÉO ---
                aoSelecionarObjeto(e) {
                    const obj = e.selected[0];
                    if (!obj) return;
                    this.arteSelecionada = true;
                    this.medidasArte.largura = parseFloat(((obj.width * obj.scaleX) / this.pixelsPorCm).toFixed(2));
                    this.medidasArte.altura = parseFloat(((obj.height * obj.scaleY) / this.pixelsPorCm).toFixed(2));
                },

                aoDeselecionarObjeto() {
                    this.arteSelecionada = false;
                },

                aoModificarObjeto() {
                    const obj = this.canvas.getActiveObject();
                    if (!obj) return;
                    this.medidasArte.largura = parseFloat(((obj.width * obj.scaleX) / this.pixelsPorCm).toFixed(2));
                    this.medidasArte.altura = parseFloat(((obj.height * obj.scaleY) / this.pixelsPorCm).toFixed(2));
                },

                atualizarArtePeloInput(tipo) {
                    const obj = this.canvas.getActiveObject();
                    if (!obj) return;

                    if (tipo === 'w') {
                        const novaEscalaX = (this.medidasArte.largura * this.pixelsPorCm) / obj.width;
                        obj.set('scaleX', novaEscalaX);
                        if (this.bloquearProporcao) {
                            obj.scaleToWidth(this.medidasArte.largura * this.pixelsPorCm);
                            this.medidasArte.altura = parseFloat(((obj.height * obj.scaleY) / this.pixelsPorCm).toFixed(2));
                        }
                    } 
                    else if (tipo === 'h') {
                        const novaEscalaY = (this.medidasArte.altura * this.pixelsPorCm) / obj.height;
                        obj.set('scaleY', novaEscalaY);
                        if (this.bloquearProporcao) {
                            obj.scaleToHeight(this.medidasArte.altura * this.pixelsPorCm);
                            this.medidasArte.largura = parseFloat(((obj.width * obj.scaleX) / this.pixelsPorCm).toFixed(2));
                        }
                    }
                    obj.setCoords(); 
                    this.canvas.renderAll();
                },

                preencherArte() {
                    const activeObj = this.canvas.getActiveObject();
                    if (activeObj) {
                        activeObj.scaleX = this.canvas.width / activeObj.width;
                        activeObj.scaleY = this.canvas.height / activeObj.height;
                        activeObj.center();
                        activeObj.setCoords();
                        this.canvas.requestRenderAll();
                        this.aoModificarObjeto();
                    }
                },

                excluirArte() {
                    const obj = this.canvas.getActiveObject();
                    if (obj) this.canvas.remove(obj);
                    this.arteSelecionada = false;
                },

                limparEditor() {
                    this.produtoSelecionado = '';
                    this.medidas = { largura: 0, altura: 0, nome: '' };
                    this.canvas.clear();
                    this.canvas.setDimensions({ width: 0, height: 0 });
                    this.zoomScale = 1;
                    this.arteSelecionada = false;
                },
                atualizarMedidas() {
                    if (this.produtoSelecionado) {
                        this.medidas.largura = this.produtoSelecionado.largura;
                        this.medidas.altura = this.produtoSelecionado.altura;
                        this.medidas.nome = this.produtoSelecionado.codigo;
                        this.redimensionarCanvas();
                    }
                },
                redimensionarCanvas() {
                    const w = this.medidas.largura * this.pixelsPorCm;
                    const h = this.medidas.altura * this.pixelsPorCm;
                    this.canvas.setDimensions({ width: w, height: h });
                    this.canvas.renderAll();
                    this.$nextTick(() => { this.ajustarZoom(); });
                },
                ajustarZoom() {
                    if (!this.medidas.largura || !this.$refs.canvasContainer) return;
                    const container = this.$refs.canvasContainer;
                    const containerW = container.clientWidth - 80; 
                    const containerH = container.clientHeight - 80;
                    const canvasW = this.medidas.largura * this.pixelsPorCm;
                    const canvasH = this.medidas.altura * this.pixelsPorCm;
                    let scale = Math.min(containerW / canvasW, containerH / canvasH);
                    if (scale > 1) scale = 1;
                    this.zoomScale = scale;
                },
                adicionarImagemCanvas(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (f) => {
                        fabric.Image.fromURL(f.target.result, (img) => {
                            img.set({
                                cornerColor: '#4f46e5',
                                cornerStyle: 'circle',
                                borderColor: '#4f46e5',
                                cornerSize: 15,
                                transparentCorners: false,
                                lockUniScaling: false
                            });
                            const canvasW = this.canvas.width;
                            if(img.width > canvasW * 0.5) {
                                img.scaleToWidth(canvasW * 0.5);
                            }
                            this.canvas.add(img);
                            img.center();
                            this.canvas.setActiveObject(img);
                            this.aoSelecionarObjeto({ selected: [img] });
                        });
                    };
                    reader.readAsDataURL(file);
                    e.target.value = '';
                },
                centralizarArte() {
                    const activeObj = this.canvas.getActiveObject();
                    if (activeObj) {
                        activeObj.center();
                        activeObj.setCoords();
                    }
                },
                deselecionarArte() {
                    this.canvas.discardActiveObject();
                    this.canvas.requestRenderAll();
                    this.arteSelecionada = false;
                },
                async baixarPDF(cor) {
                    this.loading = true;
                    this.canvas.discardActiveObject(); 

                    const dataUrl = this.canvas.toDataURL({ format: 'png', multiplier: 2 });
                    const res = await fetch(dataUrl);
                    const blobImagem = await res.blob();

                    const formData = new FormData();
                    formData.append('largura', this.medidas.largura);
                    formData.append('altura', this.medidas.altura);
                    formData.append('nome', this.medidas.nome || 'Gabarito');
                    formData.append('cor', cor);
                    formData.append('salvar_directus', this.salvarNoDirectus);
                    formData.append('imagem', blobImagem, `arte.png`);

                    try {
                        const response = await fetch('/gerar-gabarito', { method: 'POST', body: formData });
                        if(!response.ok) throw new Error("Erro na gera√ß√£o");
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Prova_${this.medidas.nome}_${cor.toUpperCase()}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    } catch (e) { alert("Erro: " + e.message); } 
                    finally { this.loading = false; }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
