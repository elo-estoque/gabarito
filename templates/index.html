<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elo Prova Digital | Editor</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#050505',
                            card: '#121212',
                            wine: '#E31937',
                            hover: '#C2132F',
                            surface: '#1E1E1E'
                        }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { background-color: #050505; color: #E5E7EB; }
        .glass-panel { background: #121212; border: 1px solid rgba(255, 255, 255, 0.05); }
        .glass-input { background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.2s; }
        .glass-input:focus { border-color: #E31937; outline: none; background: rgba(0, 0, 0, 0.5); }
        .glass-input option { background-color: #121212; color: white; }
        .canvas-wrapper {
            transform-origin: center center;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; } 
        ::-webkit-scrollbar-track { background: #050505; } 
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; } 
        ::-webkit-scrollbar-thumb:hover { background: #E31937; }
        input[type=number]::-webkit-inner-spin-button { opacity: 1; filter: invert(1); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-brand-dark font-sans text-gray-300">

    <nav class="bg-brand-card border-b border-white/5 h-16 flex-none z-30">
        <div class="max-w-[1600px] mx-auto px-6 h-full flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-brand-wine rounded flex items-center justify-center text-white">
                    <i class="fa-solid fa-print"></i>
                </div>
                <div>
                    <h1 class="font-bold text-white leading-tight tracking-tight">ELO PROVA DIGITAL</h1>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest">Sistema de Gabaritos</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <p class="text-xs font-bold text-white">{{ usuario.name }}</p>
                    <p class="text-[10px] text-gray-500">{{ usuario.email }}</p>
                </div>
                <div class="h-8 w-[1px] bg-white/10 mx-2"></div>
                <a href="/logout" class="text-gray-400 hover:text-brand-wine transition text-sm font-bold flex items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket"></i> SAIR
                </a>
            </div>
        </div>
    </nav>

    <div id="app" class="flex-1 max-w-[1600px] mx-auto w-full p-4 md:p-6 overflow-hidden flex flex-col">
        
        <div class="glass-panel rounded-2xl shadow-2xl flex flex-col h-full overflow-hidden relative">
            
            <div class="flex border-b border-white/5 bg-black/20">
                <button @click="abaPrincipal = 'editor'" :class="{'border-b-2 border-brand-wine text-white bg-white/5': abaPrincipal === 'editor', 'text-gray-500 hover:text-gray-300 hover:bg-white/5': abaPrincipal !== 'editor'}" class="px-6 py-4 font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-pen-ruler"></i> Editor
                </button>
                <button @click="abaPrincipal = 'historico'; carregarHistorico()" :class="{'border-b-2 border-brand-wine text-white bg-white/5': abaPrincipal === 'historico', 'text-gray-500 hover:text-gray-300 hover:bg-white/5': abaPrincipal !== 'historico'}" class="px-6 py-4 font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-clock-rotate-left"></i> Histórico
                </button>
                <button @click="abaPrincipal = 'downloads'" :class="{'border-b-2 border-brand-wine text-white bg-white/5': abaPrincipal === 'downloads', 'text-gray-500 hover:text-gray-300 hover:bg-white/5': abaPrincipal !== 'downloads'}" class="px-6 py-4 font-bold text-sm transition flex items-center gap-2">
                    <i class="fa-solid fa-file-arrow-down"></i> Gabaritos
                </button>
            </div>

            <div v-show="abaPrincipal === 'editor'" class="flex flex-col lg:flex-row h-full overflow-hidden">
                <div class="w-full lg:w-[320px] bg-brand-card border-r border-white/5 flex flex-col h-full overflow-y-auto z-20 shadow-xl">
                    <div class="p-5 space-y-6">
                        <div>
                            <p class="text-[10px] uppercase font-bold text-gray-500 mb-2 tracking-wider">Modo de Operação</p>
                            <div class="flex bg-black/40 rounded-lg p-1 border border-white/5">
                                <button @click="modo = 'catalogo'; limparEditor()" :class="{'bg-brand-surface text-brand-wine shadow border border-white/10': modo==='catalogo', 'text-gray-500 hover:text-gray-300': modo!=='catalogo'}" class="flex-1 py-2 rounded-md text-xs font-bold transition">Catálogo</button>
                                <button @click="modo = 'custom'; limparEditor()" :class="{'bg-brand-surface text-brand-wine shadow border border-white/10': modo==='custom', 'text-gray-500 hover:text-gray-300': modo!=='custom'}" class="flex-1 py-2 rounded-md text-xs font-bold transition">Manual</button>
                            </div>
                        </div>

                        <div v-if="modo === 'catalogo'">
                            <label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Selecione o Produto</label>
                            <select v-model="produtoSelecionado" @change="atualizarMedidas" class="w-full glass-input p-2.5 rounded-lg text-sm outline-none mb-3">
                                <option value="">Buscar produto...</option>
                                <option v-for="prod in listaProdutos" :key="prod.id" :value="prod">[[ prod.nome ]] ([[ prod.codigo ]])</option>
                            </select>

                            <div v-if="produtoSelecionado" class="bg-brand-surface border border-white/10 rounded-lg p-3 flex justify-between items-center animate-fade-in">
                                <div class="text-center w-1/2 border-r border-white/10">
                                    <span class="block text-[10px] text-gray-500 uppercase font-bold">Largura</span>
                                    <span class="block text-lg font-bold text-white">[[ medidas.largura ]] cm</span>
                                </div>
                                <div class="text-center w-1/2">
                                    <span class="block text-[10px] text-gray-500 uppercase font-bold">Altura</span>
                                    <span class="block text-lg font-bold text-white">[[ medidas.altura ]] cm</span>
                                </div>
                            </div>
                        </div>

                        <div v-if="modo === 'custom'" class="bg-brand-surface p-3 rounded-lg border border-white/10">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">Largura (cm)</label>
                                    <input type="number" step="0.1" v-model="medidas.largura" @change="redimensionarCanvas" class="w-full glass-input p-2 rounded text-sm">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500">Altura (cm)</label>
                                    <input type="number" step="0.1" v-model="medidas.altura" @change="redimensionarCanvas" class="w-full glass-input p-2 rounded text-sm">
                                </div>
                            </div>
                        </div>

                        <div class="h-px bg-white/5"></div>

                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-2">Arte do Cliente</label>
                            <label class="flex items-center justify-center w-full p-4 border border-dashed border-white/20 bg-white/5 rounded-lg text-gray-400 font-bold cursor-pointer hover:bg-white/10 hover:text-white hover:border-brand-wine transition group">
                                <i class="fa-solid fa-cloud-arrow-up mr-2 group-hover:text-brand-wine transition"></i>
                                <span class="text-xs">Carregar (IMG ou PDF)</span>
                                <input type="file" @change="adicionarImagemCanvas" accept="image/*, application/pdf" class="hidden">
                            </label>
                        </div>

                        <div v-if="arteSelecionada" class="bg-brand-surface border-l-4 border-brand-wine p-4 rounded-r-lg shadow-lg animate-fade-in">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-xs font-bold text-white uppercase"><i class="fa-solid fa-sliders mr-1 text-brand-wine"></i> Ajustar Arte</span>
                                <button @click="excluirArte" class="text-gray-500 hover:text-red-500 transition text-xs" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <div class="relative">
                                    <span class="absolute left-2 top-1.5 text-[10px] text-gray-500 font-bold">L</span>
                                    <input type="number" step="0.1" v-model="medidasArte.largura" @input="atualizarArtePeloInput('w')" class="w-full pl-5 p-1.5 glass-input rounded text-xs font-bold text-center">
                                </div>
                                <div class="relative">
                                    <span class="absolute left-2 top-1.5 text-[10px] text-gray-500 font-bold">A</span>
                                    <input type="number" step="0.1" v-model="medidasArte.altura" @input="atualizarArtePeloInput('h')" class="w-full pl-5 p-1.5 glass-input rounded text-xs font-bold text-center">
                                </div>
                            </div>

                            <div class="flex items-center justify-between">
                                <label class="flex items-center cursor-pointer select-none group" title="Travar Proporção">
                                    <input type="checkbox" v-model="bloquearProporcao" class="mr-2 h-3 w-3 accent-brand-wine rounded bg-gray-800 border-gray-600">
                                    <span class="text-[10px] font-bold text-gray-500 group-hover:text-gray-300 transition">Travar Prop.</span>
                                </label>
                                <div class="flex gap-1">
                                    <button @click="centralizarArte" class="bg-white/10 hover:bg-white/20 text-white p-1.5 rounded transition" title="Centralizar"><i class="fa-solid fa-crosshairs text-xs"></i></button>
                                    <button @click="preencherArte" class="bg-brand-wine hover:bg-brand-hover text-white p-1.5 rounded transition" title="Preencher"><i class="fa-solid fa-expand text-xs"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto p-5 border-t border-white/5 bg-black/20">
                        <div class="flex items-center mb-4 justify-center">
                            <input type="checkbox" id="saveDir" v-model="salvarNoDirectus" class="mr-2 h-4 w-4 accent-brand-wine bg-gray-800 border-gray-600 rounded">
                            <label for="saveDir" class="text-xs text-gray-400 font-bold cursor-pointer hover:text-white transition">Salvar cópia no sistema</label>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button @click="baixarPDF('rgb')" :disabled="!validar" class="p-3 rounded-lg bg-white/5 border border-white/5 hover:bg-white/10 hover:border-white/20 text-gray-300 hover:text-white flex flex-col items-center justify-center transition group disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-desktop mb-1 group-hover:text-brand-wine transition"></i>
                                <span class="text-[10px] font-bold">RGB (Tela)</span>
                            </button>
                            <button @click="baixarPDF('cmyk')" :disabled="!validar" class="p-3 rounded-lg bg-brand-wine hover:bg-brand-hover text-white flex flex-col items-center justify-center transition shadow-lg shadow-brand-wine/20 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-print mb-1"></i>
                                <span class="text-[10px] font-bold">CMYK (Print)</span>
                            </button>
                        </div>
                        <p v-if="loading" class="text-center text-[10px] text-brand-wine font-bold mt-3 animate-pulse">PROCESSANDO...</p>
                    </div>
                </div>

                <div class="flex-1 bg-[#090909] relative flex flex-col items-center overflow-hidden">
                    <div class="w-full h-12 flex justify-between items-center px-6 border-b border-white/5 bg-brand-card z-10">
                        <div class="flex items-center text-xs font-bold text-gray-500 uppercase">
                            <i class="fa-solid fa-ruler-combined mr-2 text-brand-wine"></i>
                            <span v-if="medidas.largura">Área: [[ medidas.largura ]]cm x [[ medidas.altura ]]cm</span>
                            <span v-else>Aguardando seleção...</span>
                        </div>
                        <div class="text-[10px] font-mono text-gray-400 bg-white/5 px-2 py-1 rounded border border-white/5">
                            Zoom: [[ Math.round(zoomScale * 100) ]]%
                        </div>
                    </div>
                    
                    <div ref="canvasContainer" class="flex-grow w-full flex items-center justify-center overflow-hidden relative p-10" @click.self="deselecionarArte">
                        <div v-if="!medidas.largura" class="text-center text-gray-600 select-none">
                            <i class="fa-solid fa-arrow-left text-3xl mb-3 opacity-30"></i>
                            <p class="font-bold text-sm">Selecione um produto no menu</p>
                        </div>
                        <div class="canvas-wrapper bg-white" :style="{ transform: `scale(${zoomScale})` }">
                            <canvas id="canvasEditor"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="abaPrincipal === 'historico'" class="flex-1 overflow-y-auto bg-brand-dark p-8">
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-brand-wine"></i> Registro de Atividades
                    </h2>
                    <div class="glass-panel rounded-xl overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b border-white/10 bg-white/5 text-xs uppercase text-gray-400">
                                    <th class="px-6 py-4 font-bold">Data / Hora</th>
                                    <th class="px-6 py-4 font-bold">Usuário</th>
                                    <th class="px-6 py-4 font-bold">Ação</th>
                                    <th class="px-6 py-4 font-bold">Produto / Detalhe</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5 text-sm text-gray-300">
                                <tr v-for="log in historicoLista" :key="log.id" class="hover:bg-white/5 transition">
                                    <td class="px-6 py-4 font-mono text-xs text-gray-500">[[ formatarData(log.date_created) ]]</td>
                                    <td class="px-6 py-4 font-bold text-white">[[ log.usuario ]]</td>
                                    <td class="px-6 py-4">
                                        <span :class="{'bg-green-500/10 text-green-500 border-green-500/20': log.acao.includes('Gerou'), 'bg-blue-500/10 text-blue-500 border-blue-500/20': log.acao.includes('Baixou')}" class="px-2.5 py-1 rounded text-[10px] font-bold uppercase tracking-wide border">
                                            [[ log.acao ]]
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 text-xs text-gray-400">[[ log.produto ]]</td>
                                </tr>
                                <tr v-if="historicoLista.length === 0">
                                    <td colspan="4" class="px-6 py-12 text-center text-gray-600 italic">Nenhum registro encontrado no histórico.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div v-show="abaPrincipal === 'downloads'" class="flex-1 overflow-y-auto bg-brand-dark p-8">
                <div class="max-w-5xl mx-auto">
                    
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-box-open text-brand-wine"></i> Biblioteca de Facas
                        </h2>
                        <div class="relative w-full md:w-96">
                            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-500"></i>
                            <input type="text" v-model="termoBusca" placeholder="Buscar por SKU ou Nome..." class="w-full glass-input pl-10 p-2.5 rounded-lg text-sm">
                        </div>
                    </div>

                    <div class="glass-panel rounded-xl overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b border-white/10 bg-white/5 text-xs uppercase text-gray-400">
                                    <th class="px-6 py-4 font-bold">Produto</th>
                                    <th class="px-6 py-4 font-bold">Dimensões</th>
                                    <th class="px-6 py-4 font-bold text-right">Arquivo</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5 text-sm text-gray-300">
                                <tr v-for="prod in produtosFiltrados" :key="prod.id" class="hover:bg-white/5 transition">
                                    <td class="px-6 py-4">
                                        <span class="block font-bold text-white">[[ prod.nome ]]</span>
                                        <span class="text-xs text-brand-wine font-mono">[[ prod.codigo ]]</span>
                                    </td>
                                    <td class="px-6 py-4 text-xs text-gray-400">
                                        [[ prod.largura ]]cm x [[ prod.altura ]]cm
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <a v-if="prod.arquivo_faca" 
                                           :href="directusUrl + '/assets/' + prod.arquivo_faca.id + '?download'" 
                                           target="_blank"
                                           class="inline-flex items-center gap-2 bg-white/10 hover:bg-brand-wine hover:text-white px-4 py-2 rounded transition text-xs font-bold border border-white/10">
                                            <i class="fa-solid fa-download"></i> BAIXAR PDF
                                        </a>
                                        <span v-else class="text-xs text-gray-600 italic">Indisponível</span>
                                    </td>
                                </tr>
                                <tr v-if="produtosFiltrados.length === 0">
                                    <td colspan="3" class="px-6 py-12 text-center text-gray-600">
                                        <i class="fa-regular fa-folder-open text-4xl mb-2 opacity-30"></i>
                                        <p>Nenhum gabarito encontrado.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            compilerOptions: { delimiters: ['[[', ']]'] },
            data() {
                return {
                    abaPrincipal: 'editor',
                    modo: 'catalogo',
                    loading: false,
                    listaProdutos: {{ produtos | tojson }},
                    directusUrl: "{{ directus_url }}", // Recebe a URL do Backend
                    historicoLista: [],
                    
                    // Busca na aba downloads
                    termoBusca: '',

                    produtoSelecionado: '',
                    canvas: null,
                    medidas: { largura: 0, altura: 0, nome: '' },
                    salvarNoDirectus: true,
                    pixelsPorCm: 60, 
                    zoomScale: 1,
                    
                    arteSelecionada: false, 
                    medidasArte: { largura: 0, altura: 0 },
                    bloquearProporcao: false
                }
            },
            computed: {
                validar() { return this.medidas.largura > 0 && this.medidas.altura > 0; },
                produtosFiltrados() {
                    if (!this.termoBusca) return this.listaProdutos;
                    const termo = this.termoBusca.toLowerCase();
                    return this.listaProdutos.filter(p => 
                        (p.nome && p.nome.toLowerCase().includes(termo)) || 
                        (p.codigo && p.codigo.toLowerCase().includes(termo))
                    );
                }
            },
            mounted() {
                this.canvas = new fabric.Canvas('canvasEditor', { backgroundColor: '#ffffff', preserveObjectStacking: true });
                this.canvas.on('selection:created', this.aoSelecionarObjeto);
                this.canvas.on('selection:updated', this.aoSelecionarObjeto);
                this.canvas.on('selection:cleared', this.aoDeselecionarObjeto);
                this.canvas.on('object:modified', this.aoModificarObjeto);
                this.canvas.on('object:scaling', this.aoModificarObjeto);
                window.addEventListener('resize', this.ajustarZoom);
            },
            methods: {
                async carregarHistorico() {
                    try { const res = await fetch('/api/historico'); const json = await res.json(); this.historicoLista = json.data; } catch (e) {}
                },
                formatarData(dataIso) {
                    if(!dataIso) return '-'; const d = new Date(dataIso);
                    return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                },
                aoSelecionarObjeto(e) {
                    const obj = e.selected[0]; if (!obj) return; this.arteSelecionada = true;
                    this.medidasArte.largura = parseFloat(((obj.width * obj.scaleX) / this.pixelsPorCm).toFixed(2));
                    this.medidasArte.altura = parseFloat(((obj.height * obj.scaleY) / this.pixelsPorCm).toFixed(2));
                },
                aoDeselecionarObjeto() { this.arteSelecionada = false; },
                aoModificarObjeto() {
                    const obj = this.canvas.getActiveObject(); if (!obj) return;
                    this.medidasArte.largura = parseFloat(((obj.width * obj.scaleX) / this.pixelsPorCm).toFixed(2));
                    this.medidasArte.altura = parseFloat(((obj.height * obj.scaleY) / this.pixelsPorCm).toFixed(2));
                },
                atualizarArtePeloInput(tipo) {
                    const obj = this.canvas.getActiveObject(); if (!obj) return;
                    if (tipo === 'w') {
                        const novaEscalaX = (this.medidasArte.largura * this.pixelsPorCm) / obj.width; obj.set('scaleX', novaEscalaX);
                        if (this.bloquearProporcao) { obj.scaleToWidth(this.medidasArte.largura * this.pixelsPorCm); this.medidasArte.altura = parseFloat(((obj.height * obj.scaleY) / this.pixelsPorCm).toFixed(2)); }
                    } else if (tipo === 'h') {
                        const novaEscalaY = (this.medidasArte.altura * this.pixelsPorCm) / obj.height; obj.set('scaleY', novaEscalaY);
                        if (this.bloquearProporcao) { obj.scaleToHeight(this.medidasArte.altura * this.pixelsPorCm); this.medidasArte.largura = parseFloat(((obj.width * obj.scaleX) / this.pixelsPorCm).toFixed(2)); }
                    }
                    obj.setCoords(); this.canvas.renderAll();
                },
                preencherArte() {
                    const activeObj = this.canvas.getActiveObject(); if (activeObj) {
                        activeObj.scaleX = this.canvas.width / activeObj.width; activeObj.scaleY = this.canvas.height / activeObj.height;
                        activeObj.center(); activeObj.setCoords(); this.canvas.requestRenderAll(); this.aoModificarObjeto();
                    }
                },
                excluirArte() { const obj = this.canvas.getActiveObject(); if (obj) this.canvas.remove(obj); this.arteSelecionada = false; },
                limparEditor() {
                    this.produtoSelecionado = ''; this.medidas = { largura: 0, altura: 0, nome: '' };
                    this.canvas.clear(); this.canvas.setDimensions({ width: 0, height: 0 }); this.zoomScale = 1; this.arteSelecionada = false;
                },
                atualizarMedidas() {
                    if (this.produtoSelecionado) { this.medidas.largura = this.produtoSelecionado.largura; this.medidas.altura = this.produtoSelecionado.altura; this.medidas.nome = this.produtoSelecionado.codigo; this.redimensionarCanvas(); }
                },
                redimensionarCanvas() {
                    const w = this.medidas.largura * this.pixelsPorCm; const h = this.medidas.altura * this.pixelsPorCm;
                    this.canvas.setDimensions({ width: w, height: h }); 
                    this.canvas.setBackgroundColor('#ffffff', this.canvas.renderAll.bind(this.canvas));
                    this.$nextTick(() => { this.ajustarZoom(); });
                },
                ajustarZoom() {
                    if (!this.medidas.largura || !this.$refs.canvasContainer) return;
                    const container = this.$refs.canvasContainer;
                    let scale = Math.min((container.clientWidth - 80) / (this.medidas.largura * this.pixelsPorCm), (container.clientHeight - 80) / (this.medidas.altura * this.pixelsPorCm));
                    if (scale > 1) scale = 1; this.zoomScale = scale;
                },
                async adicionarImagemCanvas(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (file.type === 'application/pdf') {
                        this.loading = true; 
                        try {
                            const fileReader = new FileReader();
                            fileReader.onload = async function() {
                                const typedarray = new Uint8Array(this.result);
                                const pdf = await pdfjsLib.getDocument(typedarray).promise;
                                const page = await pdf.getPage(1); 
                                const viewport = page.getViewport({ scale: 3 });
                                const canvasTemp = document.createElement('canvas');
                                const context = canvasTemp.getContext('2d');
                                canvasTemp.height = viewport.height;
                                canvasTemp.width = viewport.width;
                                await page.render({ canvasContext: context, viewport: viewport }).promise;
                                const imgUrl = canvasTemp.toDataURL('image/png');
                                fabric.Image.fromURL(imgUrl, (img) => {
                                    img.set({ cornerColor: '#E31937', cornerStyle: 'circle', borderColor: '#E31937', cornerSize: 15, transparentCorners: false, lockUniScaling: false });
                                    const app = document.getElementById('app').__vue_app__.config.globalProperties.$root || document.querySelector('#app').__vue_app__._instance.proxy;
                                    const canvasW = app.canvas.width;
                                    if(img.width > canvasW * 0.8) { img.scaleToWidth(canvasW * 0.5); }
                                    app.canvas.add(img); img.center(); app.canvas.setActiveObject(img); app.aoSelecionarObjeto({ selected: [img] });
                                    app.loading = false;
                                });
                            };
                            fileReader.readAsArrayBuffer(file);
                        } catch (err) {
                            alert("Erro ao ler PDF: " + err.message);
                            this.loading = false;
                        }
                    } 
                    else {
                        const reader = new FileReader();
                        reader.onload = (f) => {
                            fabric.Image.fromURL(f.target.result, (img) => {
                                img.set({ cornerColor: '#E31937', cornerStyle: 'circle', borderColor: '#E31937', cornerSize: 15, transparentCorners: false, lockUniScaling: false });
                                const canvasW = this.canvas.width; if(img.width > canvasW * 0.8) { img.scaleToWidth(canvasW * 0.5); }
                                this.canvas.add(img); img.center(); this.canvas.setActiveObject(img); this.aoSelecionarObjeto({ selected: [img] });
                            });
                        }; 
                        reader.readAsDataURL(file);
                    }
                    e.target.value = '';
                },
                centralizarArte() { const activeObj = this.canvas.getActiveObject(); if (activeObj) { activeObj.center(); activeObj.setCoords(); } },
                deselecionarArte() { this.canvas.discardActiveObject(); this.canvas.requestRenderAll(); this.arteSelecionada = false; },
                async baixarPDF(cor) {
                    this.loading = true; this.canvas.discardActiveObject(); 
                    const dataUrl = this.canvas.toDataURL({ format: 'png', multiplier: 2 });
                    const res = await fetch(dataUrl); const blobImagem = await res.blob();
                    const formData = new FormData();
                    formData.append('largura', this.medidas.largura); formData.append('altura', this.medidas.altura);
                    formData.append('nome', this.medidas.nome || 'Gabarito'); formData.append('cor', cor);
                    formData.append('salvar_directus', this.salvarNoDirectus); formData.append('imagem', blobImagem, `arte.png`);
                    try {
                        const response = await fetch('/gerar-gabarito', { method: 'POST', body: formData });
                        if(!response.ok) throw new Error("Erro na geração");
                        const blob = await response.blob(); const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = `Prova_${this.medidas.nome}_${cor.toUpperCase()}.pdf`;
                        document.body.appendChild(a); a.click(); a.remove(); this.carregarHistorico();
                    } catch (e) { alert("Erro: " + e.message); } finally { this.loading = false; }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
