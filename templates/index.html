<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Provas - Elo Brindes</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .canvas-container { margin: 0 auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border: 1px solid #ddd; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans p-4">

    <div id="app" class="w-full max-w-6xl bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col lg:flex-row">
        
        <div class="w-full lg:w-1/3 p-6 bg-white border-r border-gray-100 flex flex-col h-full">
            <h1 class="text-2xl font-bold text-indigo-900 mb-1">üñ®Ô∏è Editor de Gabarito</h1>
            <p class="text-gray-500 text-sm mb-6">Ajuste a arte no gabarito antes de baixar.</p>

            <div class="flex bg-gray-100 rounded-lg p-1 mb-6">
                <button @click="modo = 'catalogo'; limparEditor()" :class="{'bg-white shadow text-indigo-900': modo==='catalogo', 'text-gray-500': modo!=='catalogo'}" class="flex-1 py-2 rounded-md text-sm font-bold transition">Cat√°logo</button>
                <button @click="modo = 'custom'; limparEditor()" :class="{'bg-white shadow text-indigo-900': modo==='custom', 'text-gray-500': modo!=='custom'}" class="flex-1 py-2 rounded-md text-sm font-bold transition">Manual</button>
                <button @click="modo = 'novo'" :class="{'bg-white shadow text-indigo-900': modo==='novo', 'text-gray-500': modo!=='novo'}" class="flex-1 py-2 rounded-md text-sm font-bold transition">Novo Prod.</button>
            </div>

            <div v-if="modo === 'catalogo'" class="mb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Selecione o Produto</label>
                <select v-model="produtoSelecionado" @change="atualizarMedidas" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:border-indigo-500">
                    <option value="">Buscar produto...</option>
                    <option v-for="prod in listaProdutos" :key="prod.id" :value="prod">[[ prod.nome ]] ([[ prod.codigo ]])</option>
                </select>
            </div>

            <div v-if="modo === 'custom'" class="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mb-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500">Largura (cm)</label>
                        <input type="number" step="0.1" v-model="medidas.largura" @change="redimensionarCanvas" class="w-full p-2 border rounded bg-white">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Altura (cm)</label>
                        <input type="number" step="0.1" v-model="medidas.altura" @change="redimensionarCanvas" class="w-full p-2 border rounded bg-white">
                    </div>
                </div>
            </div>

             <div v-if="modo === 'novo'" class="space-y-3">
                <input v-model="novo.nome" placeholder="Nome do Produto" class="w-full p-3 border rounded">
                <input v-model="novo.codigo" placeholder="SKU / C√≥digo" class="w-full p-3 border rounded">
                <div class="grid grid-cols-2 gap-3">
                    <input v-model="novo.largura" type="number" step="0.1" placeholder="Largura (cm)" class="w-full p-3 border rounded">
                    <input v-model="novo.altura" type="number" step="0.1" placeholder="Altura (cm)" class="w-full p-3 border rounded">
                </div>
                <button @click="salvarProduto" :disabled="loading" class="w-full bg-indigo-900 text-white font-bold py-3 rounded hover:bg-indigo-800 transition">
                    [[ loading ? 'Salvando...' : 'Salvar no Directus' ]]
                </button>
            </div>

            <hr class="my-4 border-gray-200" v-if="modo !== 'novo'">

            <div v-if="modo !== 'novo'" class="flex-grow flex flex-col justify-between">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Adicionar Arte</label>
                    <label class="flex items-center justify-center w-full p-4 border-2 border-dashed border-indigo-200 rounded-lg text-indigo-600 font-bold cursor-pointer hover:bg-indigo-50 transition mb-4">
                        <i class="fa-solid fa-image mr-2"></i> Carregar Imagem
                        <input type="file" @change="adicionarImagemCanvas" accept="image/*" class="hidden">
                    </label>

                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button @click="centralizarArte" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded text-xs font-bold"><i class="fa-solid fa-compress mr-1"></i> Centralizar</button>
                        <button @click="preencherArte" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded text-xs font-bold"><i class="fa-solid fa-expand mr-1"></i> Preencher</button>
                        <button @click="limparCanvas" class="col-span-2 bg-red-100 hover:bg-red-200 text-red-600 py-2 rounded text-xs font-bold"><i class="fa-solid fa-trash mr-1"></i> Limpar Arte</button>
                    </div>

                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="saveDir" v-model="salvarNoDirectus" class="mr-2 h-4 w-4">
                        <label for="saveDir" class="text-xs text-gray-600 font-bold">Salvar arquivo final no Directus?</label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button @click="baixarPDF('rgb')" :disabled="!validar" class="p-3 rounded bg-white border border-gray-300 hover:bg-gray-50 flex flex-col items-center justify-center transition">
                        <span class="text-xl">üñ•Ô∏è</span>
                        <span class="text-xs font-bold mt-1">Visual (RGB)</span>
                    </button>
                    <button @click="baixarPDF('cmyk')" :disabled="!validar" class="p-3 rounded bg-indigo-600 text-white hover:bg-indigo-700 flex flex-col items-center justify-center transition shadow-lg">
                        <span class="text-xl">üñ®Ô∏è</span>
                        <span class="text-xs font-bold mt-1">Print (CMYK)</span>
                    </button>
                </div>
                <p v-if="loading" class="text-center text-xs text-indigo-600 font-bold mt-2 animate-pulse">Processando alta resolu√ß√£o...</p>
            </div>
        </div>

        <div class="w-full lg:w-2/3 bg-gray-200 relative flex items-center justify-center p-4 overflow-auto">
            <div class="absolute top-4 right-4 z-10 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur-sm">
                [[ medidas.largura ]]cm x [[ medidas.altura ]]cm
            </div>
            
            <div class="relative shadow-2xl bg-white">
                <canvas id="canvasEditor"></canvas>
            </div>
            
            <div v-if="!medidas.largura" class="absolute inset-0 flex items-center justify-center text-gray-400 font-bold">
                Selecione um produto para come√ßar
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            compilerOptions: { delimiters: ['[[', ']]'] },
            data() {
                return {
                    modo: 'catalogo',
                    loading: false,
                    listaProdutos: {{ produtos | tojson }},
                    produtoSelecionado: '',
                    canvas: null, // Inst√¢ncia do FabricJS
                    medidas: { largura: 0, altura: 0, nome: '' },
                    salvarNoDirectus: true,
                    novo: { nome: '', codigo: '', largura: '', altura: '' },
                    // Fator de convers√£o: 1cm = 37.79px (aproximado para tela), usaremos Zoom
                    pixelsPorCm: 40 
                }
            },
            computed: {
                validar() {
                    return this.medidas.largura > 0 && this.medidas.altura > 0;
                }
            },
            mounted() {
                // Inicializa o Fabric Canvas
                this.canvas = new fabric.Canvas('canvasEditor', {
                    backgroundColor: '#fff',
                    preserveObjectStacking: true
                });
            },
            methods: {
                // --- FUN√á√ïES DO EDITOR ---
                limparEditor() {
                    this.produtoSelecionado = '';
                    this.medidas = { largura: 0, altura: 0, nome: '' };
                    this.canvas.clear();
                    this.canvas.setBackgroundColor('#fff', this.canvas.renderAll.bind(this.canvas));
                    this.canvas.setDimensions({ width: 0, height: 0 });
                },

                atualizarMedidas() {
                    if (this.produtoSelecionado) {
                        this.medidas.largura = this.produtoSelecionado.largura;
                        this.medidas.altura = this.produtoSelecionado.altura;
                        this.medidas.nome = this.produtoSelecionado.codigo;
                        this.redimensionarCanvas();
                    }
                },

                redimensionarCanvas() {
                    // Define o tamanho visual do canvas baseado nos CM
                    const w = this.medidas.largura * this.pixelsPorCm;
                    const h = this.medidas.altura * this.pixelsPorCm;
                    
                    this.canvas.setDimensions({ width: w, height: h });
                    this.canvas.renderAll();
                },

                adicionarImagemCanvas(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (f) => {
                        fabric.Image.fromURL(f.target.result, (img) => {
                            // Ajusta imagem para caber no canvas se for muito grande
                            const canvasW = this.canvas.width;
                            const canvasH = this.canvas.height;
                            
                            // Escala inicial inteligente
                            if(img.width > canvasW || img.height > canvasH) {
                                img.scaleToWidth(canvasW * 0.8);
                            }
                            
                            img.set({
                                originX: 'center',
                                originY: 'center',
                                left: canvasW / 2,
                                top: canvasH / 2,
                                cornerColor: '#4f46e5',
                                cornerStyle: 'circle',
                                transparentCorners: false,
                                borderColor: '#4f46e5',
                                cornerSize: 12
                            });

                            this.canvas.add(img);
                            this.canvas.setActiveObject(img);
                        });
                    };
                    reader.readAsDataURL(file);
                    // Reseta o input para permitir carregar a mesma imagem
                    e.target.value = '';
                },

                centralizarArte() {
                    const activeObj = this.canvas.getActiveObject();
                    if (activeObj) {
                        activeObj.center();
                    }
                },
                
                preencherArte() {
                    const activeObj = this.canvas.getActiveObject();
                    if (activeObj) {
                        // Estica para cobrir tudo (pode distorcer, conforme pedido)
                        activeObj.set({
                            scaleX: this.canvas.width / activeObj.width,
                            scaleY: this.canvas.height / activeObj.height,
                            left: this.canvas.width / 2,
                            top: this.canvas.height / 2,
                            originX: 'center',
                            originY: 'center'
                        });
                        this.canvas.renderAll();
                    }
                },

                limparCanvas() {
                    // Remove objetos (artes), mant√©m fundo branco
                    this.canvas.remove(...this.canvas.getObjects());
                },

                // --- GERA√á√ÉO DO PDF ---
                async baixarPDF(cor) {
                    this.loading = true;
                    
                    // 1. Tira o foco da sele√ß√£o (para n√£o sair as bordas de edi√ß√£o azul)
                    this.canvas.discardActiveObject();
                    this.canvas.renderAll();

                    // 2. Exporta o canvas como BLOB (Imagem) de Alta Resolu√ß√£o
                    // Multiplier 4 garante que a imagem v√° com alta qualidade para o PDF
                    const dataUrl = this.canvas.toDataURL({
                        format: 'png',
                        multiplier: 4 // Aumenta a resolu√ß√£o em 4x
                    });

                    // Converte DataURL para Blob
                    const res = await fetch(dataUrl);
                    const blobImagem = await res.blob();

                    // 3. Monta o formul√°rio igual ao app.py espera
                    const formData = new FormData();
                    formData.append('largura', this.medidas.largura);
                    formData.append('altura', this.medidas.altura);
                    formData.append('nome', this.medidas.nome || 'Editado');
                    formData.append('cor', cor);
                    formData.append('salvar_directus', this.salvarNoDirectus);
                    
                    // Aqui est√° o segredo: Enviamos o canvas como se fosse o arquivo 'imagem'
                    formData.append('imagem', blobImagem, `arte_editada_${this.medidas.nome}.png`);

                    try {
                        const response = await fetch('/gerar-gabarito', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if(!response.ok) throw new Error("Erro na gera√ß√£o");

                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Prova_${this.medidas.nome}_${cor.toUpperCase()}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    } catch (e) {
                        alert("Erro: " + e.message);
                    } finally {
                        this.loading = false;
                    }
                },

                // --- SALVAR PRODUTO NOVO (Igual antes) ---
                async salvarProduto() {
                    this.loading = true;
                    try {
                        const res = await fetch('/cadastrar-produto', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(this.novo)
                        });
                        if(res.ok) window.location.reload();
                        else alert("Erro ao salvar");
                    } catch(e) { alert(e.message) }
                    finally { this.loading = false; }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
