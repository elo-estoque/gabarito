<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Provas - Elo Brindes</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Centraliza o canvas na tela de preview */
        .canvas-wrapper {
            transform-origin: top center; /* O zoom parte do topo/centro */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: transform 0.3s ease; /* Suaviza o zoom */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans p-4">

    <div id="app" class="w-full max-w-[1400px] bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col lg:flex-row h-[90vh]">
        
        <div class="w-full lg:w-1/4 p-6 bg-white border-r border-gray-100 flex flex-col h-full overflow-y-auto z-20 shadow-lg">
            <h1 class="text-xl font-bold text-indigo-900 mb-1">üñ®Ô∏è Editor Elo</h1>
            <p class="text-gray-500 text-xs mb-6">Ajuste a arte no gabarito.</p>

            <div class="flex bg-gray-100 rounded-lg p-1 mb-6 text-xs">
                <button @click="modo = 'catalogo'; limparEditor()" :class="{'bg-white shadow text-indigo-900': modo==='catalogo', 'text-gray-500': modo!=='catalogo'}" class="flex-1 py-2 rounded-md font-bold transition">Cat√°logo</button>
                <button @click="modo = 'custom'; limparEditor()" :class="{'bg-white shadow text-indigo-900': modo==='custom', 'text-gray-500': modo!=='custom'}" class="flex-1 py-2 rounded-md font-bold transition">Manual</button>
            </div>

            <div v-if="modo === 'catalogo'" class="mb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Selecione o Produto</label>
                <select v-model="produtoSelecionado" @change="atualizarMedidas" class="w-full p-2 border border-gray-300 rounded text-sm outline-none focus:border-indigo-500">
                    <option value="">Buscar produto...</option>
                    <option v-for="prod in listaProdutos" :key="prod.id" :value="prod">[[ prod.nome ]] ([[ prod.codigo ]])</option>
                </select>
            </div>

            <div v-if="modo === 'custom'" class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 mb-4">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[10px] font-bold text-gray-500">Largura (cm)</label>
                        <input type="number" step="0.1" v-model="medidas.largura" @change="redimensionarCanvas" class="w-full p-2 border rounded bg-white text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500">Altura (cm)</label>
                        <input type="number" step="0.1" v-model="medidas.altura" @change="redimensionarCanvas" class="w-full p-2 border rounded bg-white text-sm">
                    </div>
                </div>
            </div>

            <div class="flex-grow flex flex-col">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Sua Arte</label>
                    <label class="flex flex-col items-center justify-center w-full p-3 border-2 border-dashed border-indigo-200 rounded-lg text-indigo-600 font-bold cursor-pointer hover:bg-indigo-50 transition mb-3">
                        <i class="fa-solid fa-cloud-arrow-up text-xl mb-1"></i>
                        <span class="text-xs">Carregar Imagem</span>
                        <input type="file" @change="adicionarImagemCanvas" accept="image/*" class="hidden">
                    </label>

                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button @click="centralizarArte" class="bg-gray-100 hover:bg-gray-200 text-gray-600 py-2 rounded text-[10px] font-bold uppercase"><i class="fa-solid fa-crosshairs mr-1"></i> Centralizar</button>
                        <button @click="preencherArte" class="bg-gray-100 hover:bg-gray-200 text-gray-600 py-2 rounded text-[10px] font-bold uppercase"><i class="fa-solid fa-maximize mr-1"></i> Preencher</button>
                    </div>
                    <button @click="limparCanvas" class="w-full bg-red-50 hover:bg-red-100 text-red-500 py-2 rounded text-[10px] font-bold uppercase mb-4"><i class="fa-solid fa-trash mr-1"></i> Limpar Tudo</button>

                    <div class="flex items-center mb-4 bg-blue-50 p-2 rounded">
                        <input type="checkbox" id="saveDir" v-model="salvarNoDirectus" class="mr-2 h-4 w-4 accent-indigo-600">
                        <label for="saveDir" class="text-xs text-gray-700 font-bold">Salvar c√≥pia no sistema?</label>
                    </div>
                </div>

                <div class="mt-auto space-y-2">
                    <button @click="baixarPDF('rgb')" :disabled="!validar" class="w-full p-3 rounded-lg border border-gray-300 hover:bg-gray-50 flex items-center justify-center transition group">
                        <i class="fa-solid fa-desktop text-gray-400 group-hover:text-indigo-600 mr-3"></i>
                        <div class="text-left">
                            <span class="block text-xs font-bold text-gray-700">Visualizar (RGB)</span>
                            <span class="block text-[10px] text-gray-400">Para aprova√ß√£o do cliente</span>
                        </div>
                    </button>
                    <button @click="baixarPDF('cmyk')" :disabled="!validar" class="w-full p-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 flex items-center justify-center transition shadow-lg">
                        <i class="fa-solid fa-print mr-3 text-indigo-200"></i>
                        <div class="text-left">
                            <span class="block text-xs font-bold">Impress√£o (CMYK)</span>
                            <span class="block text-[10px] text-indigo-200">Para produ√ß√£o final</span>
                        </div>
                    </button>
                </div>
                <p v-if="loading" class="text-center text-xs text-indigo-600 font-bold mt-2 animate-pulse">Gerando PDF...</p>
            </div>
        </div>

        <div class="w-full lg:w-3/4 bg-slate-200 relative flex flex-col items-center overflow-hidden">
            
            <div class="w-full bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center shadow-sm z-10 h-12 shrink-0">
                <div class="text-xs font-bold text-gray-500 uppercase flex items-center">
                    <i class="fa-solid fa-ruler-combined mr-2"></i>
                    <span v-if="medidas.largura">[[ medidas.largura ]]cm x [[ medidas.altura ]]cm</span>
                    <span v-else>Sem medidas</span>
                </div>
                <div class="text-xs font-mono text-gray-400 bg-gray-100 px-2 py-1 rounded">
                    Zoom: [[ Math.round(zoomScale * 100) ]]%
                </div>
            </div>
            
            <div ref="canvasContainer" class="flex-grow w-full flex items-center justify-center overflow-hidden relative p-8">
                
                <div v-if="!medidas.largura" class="text-center text-gray-400">
                    <i class="fa-solid fa-arrow-left text-3xl mb-2"></i>
                    <p class="font-bold">Selecione um produto ao lado</p>
                </div>

                <div class="canvas-wrapper" :style="{ transform: `scale(${zoomScale})` }">
                    <canvas id="canvasEditor"></canvas>
                </div>

            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            compilerOptions: { delimiters: ['[[', ']]'] },
            data() {
                return {
                    modo: 'catalogo',
                    loading: false,
                    listaProdutos: {{ produtos | tojson }},
                    produtoSelecionado: '',
                    canvas: null,
                    medidas: { largura: 0, altura: 0, nome: '' },
                    salvarNoDirectus: true,
                    // Alta resolu√ß√£o para impress√£o (60px por cm garante boa qualidade na tela antes de exportar)
                    pixelsPorCm: 60, 
                    zoomScale: 1
                }
            },
            computed: {
                validar() {
                    return this.medidas.largura > 0 && this.medidas.altura > 0;
                }
            },
            mounted() {
                this.canvas = new fabric.Canvas('canvasEditor', {
                    backgroundColor: '#ffffff',
                    preserveObjectStacking: true,
                    selection: true
                });
                
                // Recalcula o zoom se a janela mudar de tamanho
                window.addEventListener('resize', this.ajustarZoom);
            },
            methods: {
                limparEditor() {
                    this.produtoSelecionado = '';
                    this.medidas = { largura: 0, altura: 0, nome: '' };
                    this.canvas.clear();
                    this.canvas.setDimensions({ width: 0, height: 0 });
                    this.zoomScale = 1;
                },

                atualizarMedidas() {
                    if (this.produtoSelecionado) {
                        this.medidas.largura = this.produtoSelecionado.largura;
                        this.medidas.altura = this.produtoSelecionado.altura;
                        this.medidas.nome = this.produtoSelecionado.codigo;
                        this.redimensionarCanvas();
                    }
                },

                redimensionarCanvas() {
                    // 1. Define o tamanho REAL (em pixels de alta qualidade)
                    const w = this.medidas.largura * this.pixelsPorCm;
                    const h = this.medidas.altura * this.pixelsPorCm;
                    
                    this.canvas.setDimensions({ width: w, height: h });
                    this.canvas.renderAll();

                    // 2. Ajusta o zoom visual para caber na tela
                    this.$nextTick(() => {
                        this.ajustarZoom();
                    });
                },

                ajustarZoom() {
                    if (!this.medidas.largura || !this.$refs.canvasContainer) return;

                    const container = this.$refs.canvasContainer;
                    // Pega o tamanho dispon√≠vel na div cinza (menos um padding de seguran√ßa)
                    const containerW = container.clientWidth - 80; 
                    const containerH = container.clientHeight - 80;

                    const canvasW = this.medidas.largura * this.pixelsPorCm;
                    const canvasH = this.medidas.altura * this.pixelsPorCm;

                    // Calcula qual o zoom necess√°rio para caber largura e altura
                    const scaleX = containerW / canvasW;
                    const scaleY = containerH / canvasH;

                    // Escolhe o menor para garantir que tudo caiba
                    let scale = Math.min(scaleX, scaleY);
                    
                    // Limita o zoom a 100% (se a tela for gigante, n√£o estica al√©m do real)
                    if (scale > 1) scale = 1;

                    this.zoomScale = scale;
                },

                adicionarImagemCanvas(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (f) => {
                        fabric.Image.fromURL(f.target.result, (img) => {
                            // --- HABILITA CONTROLES DE ESTICAR ---
                            // Por padr√£o, 'middle controls' (ml, mr, mt, mb) permitem esticar
                            img.set({
                                cornerColor: '#4f46e5',
                                cornerStyle: 'circle',
                                borderColor: '#4f46e5',
                                cornerSize: 20, // Bolinhas maiores para facilitar clique
                                transparentCorners: false,
                                padding: 10,
                                // Permite dimensionar ignorando a propor√ß√£o original
                                lockUniScaling: false 
                            });

                            // Garante que todos os controles de redimensionamento estejam vis√≠veis
                            img.setControlsVisibility({
                                mt: true, mb: true, ml: true, mr: true, // Meios (Esticar)
                                bl: true, br: true, tl: true, tr: true, // Cantos (Proporcional)
                                mtr: true // Rota√ß√£o
                            });

                            // Ajusta tamanho inicial para n√£o ficar gigante
                            const canvasW = this.canvas.width;
                            const canvasH = this.canvas.height;
                            
                            if(img.width > canvasW * 0.8 || img.height > canvasH * 0.8) {
                                img.scaleToWidth(canvasW * 0.6);
                            }
                            
                            img.center();
                            this.canvas.add(img);
                            this.canvas.setActiveObject(img);
                        });
                    };
                    reader.readAsDataURL(file);
                    e.target.value = '';
                },

                centralizarArte() {
                    const activeObj = this.canvas.getActiveObject();
                    if (activeObj) {
                        activeObj.center();
                    }
                },
                
                preencherArte() {
                    const activeObj = this.canvas.getActiveObject();
                    if (activeObj) {
                        // For√ßa a imagem a ter o tamanho exato do canvas (esticando)
                        activeObj.scaleX = this.canvas.width / activeObj.width;
                        activeObj.scaleY = this.canvas.height / activeObj.height;
                        activeObj.center();
                        activeObj.setCoords(); // Atualiza a √°rea de clique
                        this.canvas.requestRenderAll();
                    }
                },

                limparCanvas() {
                    this.canvas.remove(...this.canvas.getObjects());
                },

                async baixarPDF(cor) {
                    this.loading = true;
                    this.canvas.discardActiveObject();
                    this.canvas.renderAll();

                    // Gera imagem em alta resolu√ß√£o
                    // multiplier: 2 com pixelsPorCm: 60 j√° gera uma imagem excelente
                    const dataUrl = this.canvas.toDataURL({
                        format: 'png',
                        multiplier: 2 
                    });

                    const res = await fetch(dataUrl);
                    const blobImagem = await res.blob();

                    const formData = new FormData();
                    formData.append('largura', this.medidas.largura);
                    formData.append('altura', this.medidas.altura);
                    formData.append('nome', this.medidas.nome || 'Gabarito');
                    formData.append('cor', cor);
                    formData.append('salvar_directus', this.salvarNoDirectus);
                    formData.append('imagem', blobImagem, `arte_editada.png`);

                    try {
                        const response = await fetch('/gerar-gabarito', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if(!response.ok) throw new Error("Erro na gera√ß√£o");

                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Prova_${this.medidas.nome}_${cor.toUpperCase()}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    } catch (e) {
                        alert("Erro: " + e.message);
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
