<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Provas - Elo Brindes</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Ajuste para o Canvas flutuar no centro com zoom */
        .canvas-wrapper {
            transform-origin: center center; /* Zoom a partir do meio */
            box-shadow: 0 0 50px rgba(0,0,0,0.5); /* Sombra forte para destacar o papel */
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        input[type=number]::-webkit-inner-spin-button { opacity: 1; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Fundo quadriculado (transparência) caso precisem ver fora da área de impressão no futuro, 
           mas por enquanto vamos de fundo escuro sólido para destacar o branco */
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <nav class="bg-indigo-900 text-white shadow-md">
        <div class="max-w-[1400px] mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-print text-2xl"></i>
                <span class="font-bold text-lg tracking-wide">Elo Brindes <span class="text-indigo-300 text-sm font-normal">| Prova Digital</span></span>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-sm text-right">
                    <p class="font-bold">{{ usuario.name }}</p>
                    <p class="text-xs text-indigo-300">{{ usuario.email }}</p>
                </div>
                <a href="/logout" class="bg-indigo-800 hover:bg-indigo-700 px-3 py-2 rounded text-xs font-bold transition border border-indigo-700">
                    <i class="fa-solid fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </div>
    </nav>

    <div id="app" class="w-full max-w-[1400px] mx-auto mt-6 bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col h-[85vh]">
        
        <div class="flex border-b border-gray-200">
            <button @click="abaPrincipal = 'editor'" :class="{'border-b-4 border-indigo-600 text-indigo-900 bg-indigo-50': abaPrincipal === 'editor', 'text-gray-500 hover:bg-gray-50': abaPrincipal !== 'editor'}" class="px-8 py-4 font-bold transition flex items-center gap-2">
                <i class="fa-solid fa-pen-ruler"></i> Editor & Gerador
            </button>
            <button @click="abaPrincipal = 'historico'; carregarHistorico()" :class="{'border-b-4 border-indigo-600 text-indigo-900 bg-indigo-50': abaPrincipal === 'historico', 'text-gray-500 hover:bg-gray-50': abaPrincipal !== 'historico'}" class="px-8 py-4 font-bold transition flex items-center gap-2">
                <i class="fa-solid fa-clock-rotate-left"></i> Histórico
            </button>
        </div>

        <div v-show="abaPrincipal === 'editor'" class="flex flex-col lg:flex-row h-full overflow-hidden">
            
            <div class="w-full lg:w-1/4 p-5 bg-white border-r border-gray-200 flex flex-col h-full overflow-y-auto z-20 shadow-lg">
                
                <div class="flex bg-gray-100 rounded-lg p-1 mb-4 text-xs">
                    <button @click="modo = 'catalogo'; limparEditor()" :class="{'bg-white shadow text-indigo-900': modo==='catalogo', 'text-gray-500': modo!=='catalogo'}" class="flex-1 py-2 rounded-md font-bold transition">Catálogo</button>
                    <button @click="modo = 'custom'; limparEditor()" :class="{'bg-white shadow text-indigo-900': modo==='custom', 'text-gray-500': modo!=='custom'}" class="flex-1 py-2 rounded-md font-bold transition">Manual</button>
                </div>

                <div v-if="modo === 'catalogo'" class="mb-4">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 block">Produto</label>
                    <select v-model="produtoSelecionado" @change="atualizarMedidas" class="w-full p-2 border border-gray-300 rounded text-sm outline-none focus:border-indigo-500 mb-2">
                        <option value="">Selecione...</option>
                        <option v-for="prod in listaProdutos" :key="prod.id" :value="prod">[[ prod.nome ]] ([[ prod.codigo ]])</option>
                    </select>

                    <div v-if="produtoSelecionado" class="bg-indigo-50 border border-indigo-100 rounded-lg p-3 flex justify-between items-center animate-fade-in">
                        <div class="text-center w-1/2 border-r border-indigo-200">
                            <span class="block text-[10px] text-indigo-400 uppercase font-bold">Largura</span>
                            <span class="block text-lg font-extrabold text-indigo-900">[[ medidas.largura ]] cm</span>
                        </div>
                        <div class="text-center w-1/2">
                            <span class="block text-[10px] text-indigo-400 uppercase font-bold">Altura</span>
                            <span class="block text-lg font-extrabold text-indigo-900">[[ medidas.altura ]] cm</span>
                        </div>
                    </div>
                </div>

                <div v-if="modo === 'custom'" class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 mb-4">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-[10px] font-bold text-gray-500">Largura (cm)</label>
                            <input type="number" step="0.1" v-model="medidas.largura" @change="redimensionarCanvas" class="w-full p-2 border rounded bg-white text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-500">Altura (cm)</label>
                            <input type="number" step="0.1" v-model="medidas.altura" @change="redimensionarCanvas" class="w-full p-2 border rounded bg-white text-sm">
                        </div>
                    </div>
                </div>

                <hr class="border-gray-200 mb-4">

                <div class="flex-grow flex flex-col">
                    <label class="flex items-center justify-center w-full p-3 border-2 border-dashed border-indigo-200 rounded-lg text-indigo-600 font-bold cursor-pointer hover:bg-indigo-50 transition mb-4">
                        <i class="fa-solid fa-image mr-2"></i>
                        <span class="text-xs">Carregar Arte</span>
                        <input type="file" @change="adicionarImagemCanvas" accept="image/*" class="hidden">
                    </label>

                    <div v-if="arteSelecionada" class="bg-white border border-indigo-100 p-3 rounded-lg shadow-sm mb-4 ring-1 ring-indigo-50">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-indigo-900 uppercase"><i class="fa-solid fa-sliders mr-1"></i> Ajustes</span>
                            <button @click="excluirArte" class="text-red-400 hover:text-red-600 text-xs" title="Excluir"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div class="relative">
                                <span class="absolute left-2 top-1.5 text-[10px] text-gray-400">L</span>
                                <input type="number" step="0.1" v-model="medidasArte.largura" @input="atualizarArtePeloInput('w')" class="w-full pl-5 p-1 border border-gray-200 rounded text-sm font-bold text-gray-700 bg-gray-50">
                            </div>
                            <div class="relative">
                                <span class="absolute left-2 top-1.5 text-[10px] text-gray-400">A</span>
                                <input type="number" step="0.1" v-model="medidasArte.altura" @input="atualizarArtePeloInput('h')" class="w-full pl-5 p-1 border border-gray-200 rounded text-sm font-bold text-gray-700 bg-gray-50">
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <label class="flex items-center cursor-pointer select-none" title="Travar Proporção">
                                <input type="checkbox" v-model="bloquearProporcao" class="mr-1.5 h-3 w-3 text-indigo-600 border-gray-300 rounded">
                                <i :class="bloquearProporcao ? 'fa-solid fa-link text-indigo-600' : 'fa-solid fa-link-slash text-gray-300'"></i>
                            </label>
                            <div class="flex space-x-1">
                                <button @click="centralizarArte" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200" title="Centralizar"><i class="fa-solid fa-crosshairs"></i></button>
                                <button @click="preencherArte" class="text-[10px] bg-indigo-600 text-white px-2 py-1 rounded hover:bg-indigo-700" title="Preencher"><i class="fa-solid fa-expand"></i></button>
                            </div>
                        </div>
                    </div>

                    <div v-else class="text-center text-gray-300 text-xs py-4 mb-4 select-none">
                        Clique na imagem para editar
                    </div>

                    <div class="mt-auto">
                        <div class="flex items-center mb-3 justify-center">
                            <input type="checkbox" id="saveDir" v-model="salvarNoDirectus" class="mr-2 h-4 w-4 accent-indigo-600">
                            <label for="saveDir" class="text-xs text-gray-500 font-bold cursor-pointer">Salvar cópia no sistema</label>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button @click="baixarPDF('rgb')" :disabled="!validar" class="p-3 rounded-lg border border-gray-300 hover:bg-gray-50 flex flex-col items-center justify-center transition group">
                                <i class="fa-solid fa-desktop text-gray-400 group-hover:text-indigo-600 mb-1"></i>
                                <span class="text-[10px] font-bold text-gray-600">RGB (Visual)</span>
                            </button>
                            <button @click="baixarPDF('cmyk')" :disabled="!validar" class="p-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 flex flex-col items-center justify-center transition shadow-lg">
                                <i class="fa-solid fa-print mb-1"></i>
                                <span class="text-[10px] font-bold">CMYK (Print)</span>
                            </button>
                        </div>
                        <p v-if="loading" class="text-center text-xs text-indigo-600 font-bold mt-2 animate-pulse">Gerando PDF...</p>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-3/4 bg-gray-800 relative flex flex-col items-center overflow-hidden">
                
                <div class="w-full bg-gray-900 border-b border-gray-700 px-4 py-2 flex justify-between items-center shadow-lg z-10 h-10 shrink-0">
                    <div class="text-xs font-bold text-gray-400 uppercase flex items-center">
                        <i class="fa-solid fa-ruler-combined mr-2 text-indigo-400"></i>
                        <span v-if="medidas.largura">Área: [[ medidas.largura ]]cm x [[ medidas.altura ]]cm</span>
                        <span v-else>Selecione um produto</span>
                    </div>
                    <div class="text-[10px] font-mono text-gray-500 bg-gray-800 px-2 py-1 rounded border border-gray-700">
                        Zoom: [[ Math.round(zoomScale * 100) ]]%
                    </div>
                </div>
                
                <div ref="canvasContainer" class="flex-grow w-full flex items-center justify-center overflow-hidden relative p-10" @click.self="deselecionarArte">
                    
                    <div v-if="!medidas.largura" class="text-center text-gray-600">
                        <i class="fa-solid fa-arrow-left text-2xl mb-2 opacity-50"></i>
                        <p class="font-bold text-sm">Comece selecionando um produto</p>
                    </div>

                    <div class="canvas-wrapper bg-white" :style="{ transform: `scale(${zoomScale})` }">
                        <canvas id="canvasEditor"></canvas>
                    </div>

                </div>
            </div>
        </div>

        <div v-show="abaPrincipal === 'historico'" class="p-8 h-full overflow-y-auto bg-gray-50">
            <h2 class="text-xl font-bold text-indigo-900 mb-6 flex items-center gap-2">
                <i class="fa-solid fa-clock-rotate-left"></i> Histórico de Atividades
            </h2>
            <div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100 border-b">
                        <tr>
                            <th class="px-6 py-3">Data</th>
                            <th class="px-6 py-3">Usuário</th>
                            <th class="px-6 py-3">Ação</th>
                            <th class="px-6 py-3">Produto</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="log in historicoLista" :key="log.id" class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-mono text-xs">[[ formatarData(log.date_created) ]]</td>
                            <td class="px-6 py-4 font-bold text-indigo-900">[[ log.usuario ]]</td>
                            <td class="px-6 py-4">
                                <span :class="{'bg-green-100 text-green-800': log.acao.includes('Gerou'), 'bg-blue-100 text-blue-800': log.acao.includes('Baixou')}" class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wide">
                                    [[ log.acao ]]
                                </span>
                            </td>
                            <td class="px-6 py-4 text-xs">[[ log.produto ]]</td>
                        </tr>
                        <tr v-if="historicoLista.length === 0">
                            <td colspan="4" class="px-6 py-8 text-center text-gray-400">Nenhum registro encontrado.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            compilerOptions: { delimiters: ['[[', ']]'] },
            data() {
                return {
                    abaPrincipal: 'editor',
                    modo: 'catalogo',
                    loading: false,
                    listaProdutos: {{ produtos | tojson }},
                    historicoLista: [],
                    
                    produtoSelecionado: '',
                    canvas: null,
                    medidas: { largura: 0, altura: 0, nome: '' },
                    salvarNoDirectus: true,
                    pixelsPorCm: 60, 
                    zoomScale: 1,
                    
                    arteSelecionada: false, 
                    medidasArte: { largura: 0, altura: 0 },
                    bloquearProporcao: false
                }
            },
            computed: {
                validar() { return this.medidas.largura > 0 && this.medidas.altura > 0; }
            },
            mounted() {
                this.canvas = new fabric.Canvas('canvasEditor', { backgroundColor: '#ffffff', preserveObjectStacking: true });
                this.canvas.on('selection:created', this.aoSelecionarObjeto);
                this.canvas.on('selection:updated', this.aoSelecionarObjeto);
                this.canvas.on('selection:cleared', this.aoDeselecionarObjeto);
                this.canvas.on('object:modified', this.aoModificarObjeto);
                this.canvas.on('object:scaling', this.aoModificarObjeto);
                window.addEventListener('resize', this.ajustarZoom);
            },
            methods: {
                async carregarHistorico() {
                    try { const res = await fetch('/api/historico'); const json = await res.json(); this.historicoLista = json.data; } catch (e) {}
                },
                formatarData(dataIso) {
                    if(!dataIso) return '-'; const d = new Date(dataIso);
                    return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                },
                aoSelecionarObjeto(e) {
                    const obj = e.selected[0]; if (!obj) return; this.arteSelecionada = true;
                    this.medidasArte.largura = parseFloat(((obj.width * obj.scaleX) / this.pixelsPorCm).toFixed(2));
                    this.medidasArte.altura = parseFloat(((obj.height * obj.scaleY) / this.pixelsPorCm).toFixed(2));
                },
                aoDeselecionarObjeto() { this.arteSelecionada = false; },
                aoModificarObjeto() {
                    const obj = this.canvas.getActiveObject(); if (!obj) return;
                    this.medidasArte.largura = parseFloat(((obj.width * obj.scaleX) / this.pixelsPorCm).toFixed(2));
                    this.medidasArte.altura = parseFloat(((obj.height * obj.scaleY) / this.pixelsPorCm).toFixed(2));
                },
                atualizarArtePeloInput(tipo) {
                    const obj = this.canvas.getActiveObject(); if (!obj) return;
                    if (tipo === 'w') {
                        const novaEscalaX = (this.medidasArte.largura * this.pixelsPorCm) / obj.width; obj.set('scaleX', novaEscalaX);
                        if (this.bloquearProporcao) { obj.scaleToWidth(this.medidasArte.largura * this.pixelsPorCm); this.medidasArte.altura = parseFloat(((obj.height * obj.scaleY) / this.pixelsPorCm).toFixed(2)); }
                    } else if (tipo === 'h') {
                        const novaEscalaY = (this.medidasArte.altura * this.pixelsPorCm) / obj.height; obj.set('scaleY', novaEscalaY);
                        if (this.bloquearProporcao) { obj.scaleToHeight(this.medidasArte.altura * this.pixelsPorCm); this.medidasArte.largura = parseFloat(((obj.width * obj.scaleX) / this.pixelsPorCm).toFixed(2)); }
                    }
                    obj.setCoords(); this.canvas.renderAll();
                },
                preencherArte() {
                    const activeObj = this.canvas.getActiveObject(); if (activeObj) {
                        activeObj.scaleX = this.canvas.width / activeObj.width; activeObj.scaleY = this.canvas.height / activeObj.height;
                        activeObj.center(); activeObj.setCoords(); this.canvas.requestRenderAll(); this.aoModificarObjeto();
                    }
                },
                excluirArte() { const obj = this.canvas.getActiveObject(); if (obj) this.canvas.remove(obj); this.arteSelecionada = false; },
                limparEditor() {
                    this.produtoSelecionado = ''; this.medidas = { largura: 0, altura: 0, nome: '' };
                    this.canvas.clear(); this.canvas.setDimensions({ width: 0, height: 0 }); this.zoomScale = 1; this.arteSelecionada = false;
                },
                atualizarMedidas() {
                    if (this.produtoSelecionado) { this.medidas.largura = this.produtoSelecionado.largura; this.medidas.altura = this.produtoSelecionado.altura; this.medidas.nome = this.produtoSelecionado.codigo; this.redimensionarCanvas(); }
                },
                redimensionarCanvas() {
                    const w = this.medidas.largura * this.pixelsPorCm; const h = this.medidas.altura * this.pixelsPorCm;
                    this.canvas.setDimensions({ width: w, height: h }); 
                    // Garante fundo branco explícito
                    this.canvas.setBackgroundColor('#ffffff', this.canvas.renderAll.bind(this.canvas));
                    this.$nextTick(() => { this.ajustarZoom(); });
                },
                ajustarZoom() {
                    if (!this.medidas.largura || !this.$refs.canvasContainer) return;
                    const container = this.$refs.canvasContainer;
                    // Margem de segurança de 80px (40 de cada lado)
                    let scale = Math.min((container.clientWidth - 80) / (this.medidas.largura * this.pixelsPorCm), (container.clientHeight - 80) / (this.medidas.altura * this.pixelsPorCm));
                    if (scale > 1) scale = 1; this.zoomScale = scale;
                },
                adicionarImagemCanvas(e) {
                    const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
                    reader.onload = (f) => {
                        fabric.Image.fromURL(f.target.result, (img) => {
                            img.set({ cornerColor: '#4f46e5', cornerStyle: 'circle', borderColor: '#4f46e5', cornerSize: 15, transparentCorners: false, lockUniScaling: false });
                            const canvasW = this.canvas.width; if(img.width > canvasW * 0.8) { img.scaleToWidth(canvasW * 0.5); }
                            this.canvas.add(img); img.center(); this.canvas.setActiveObject(img); this.aoSelecionarObjeto({ selected: [img] });
                        });
                    }; reader.readAsDataURL(file); e.target.value = '';
                },
                centralizarArte() { const activeObj = this.canvas.getActiveObject(); if (activeObj) { activeObj.center(); activeObj.setCoords(); } },
                deselecionarArte() { this.canvas.discardActiveObject(); this.canvas.requestRenderAll(); this.arteSelecionada = false; },
                async baixarPDF(cor) {
                    this.loading = true; this.canvas.discardActiveObject(); 
                    const dataUrl = this.canvas.toDataURL({ format: 'png', multiplier: 2 });
                    const res = await fetch(dataUrl); const blobImagem = await res.blob();
                    const formData = new FormData();
                    formData.append('largura', this.medidas.largura); formData.append('altura', this.medidas.altura);
                    formData.append('nome', this.medidas.nome || 'Gabarito'); formData.append('cor', cor);
                    formData.append('salvar_directus', this.salvarNoDirectus); formData.append('imagem', blobImagem, `arte.png`);
                    try {
                        const response = await fetch('/gerar-gabarito', { method: 'POST', body: formData });
                        if(!response.ok) throw new Error("Erro na geração");
                        const blob = await response.blob(); const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = `Prova_${this.medidas.nome}_${cor.toUpperCase()}.pdf`;
                        document.body.appendChild(a); a.click(); a.remove(); this.carregarHistorico();
                    } catch (e) { alert("Erro: " + e.message); } finally { this.loading = false; }
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
